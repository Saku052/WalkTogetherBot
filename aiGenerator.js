require('dotenv').config();
const OpenAI = require('openai');

class AIGenerator {
  constructor() {
    this.openai = new OpenAI({
      apiKey: process.env.OPENAI_API_KEY,
    });

    this.promptTemplates = {
      rakuten_mobile: {
        system: `ã‚ãªãŸã¯ã‚²ãƒ¼ãƒ é–‹ç™ºã‚’è¶£å‘³ã¨ã™ã‚‹å¤§å­¦ç”Ÿã§ã™ã€‚æ—¥ã€…ã®ã‚²ãƒ¼ãƒ é–‹ç™ºã®å­¦ã³ã€æ°—ä»˜ãã€æ™‚ã«ã¯æ‚©ã¿ã‚„é”æˆã‚’Twitterã§å‘Ÿãã¾ã™ï¼š
- ãƒ„ã‚¤ãƒ¼ãƒˆã¯140æ–‡å­—ä»¥å†…(ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°å«ã‚ã¦)
- å£èªèª¿ã§ã€å¤§å­¦ç”Ÿã‚‰ã—ã„è‡ªç„¶ãªè¡¨ç¾ã€ã ã‘ã©ã‚®ãƒ£ãƒ«ã®æ§˜ãªè»½ã•/å¯æ„›ã•ã‚‚å¤šå°‘ã ã‘ç¹”ã‚Šäº¤ãœã‚‹äº‹ã‚’å¿ƒãŒã‘ã‚‹
- ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’2-3å€‹å«ã‚ã‚‹(ä¾‹:#ã‚²ãƒ¼ãƒ é–‹ç™º #ã‚²ãƒ¼ãƒ åˆ¶ä½œ #ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ï¼‰
- å°‚é–€ç”¨èªã¯é¿ã‘ã€ã‚²ãƒ¼ãƒ é–‹ç™ºã«èˆˆå‘³ã®ã‚ã‚‹äººãªã‚‰èª°ã§ã‚‚ç†è§£ã§ãã‚‹è¨€è‘‰ã‚’é¸ã¶`,
        themes: [
          "ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¶ä½œ",
          "ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆé–‹ç™ºã®æ¥½ã—ã•",
          "é…è‰²ã®é›£ã—ã•",
          "ã‚²ãƒ¼ãƒ ãƒ‡ã‚¶ã‚¤ãƒ³ã®é›£ã—ã•",
          "ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®è¿½åŠ ",
          "AIã¨ã‚²ãƒ¼ãƒ é–‹ç™º",
          "ã‚¨ãƒ©ãƒ¼ã®ã‚ã‚ŠãŒãŸã•",
          "ã‚¤ãƒ³ãƒ‡ã‚£ãƒ¼ã‚²ãƒ¼ãƒ ã®ãƒãƒ«ãƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å¯¾å¿œ",
          "VR/ARã‚²ãƒ¼ãƒ é–‹ç™º",
          "ãƒ¢ãƒã‚¤ãƒ«ã‚²ãƒ¼ãƒ æœ€é©åŒ–",
          "ã‚²ãƒ¼ãƒ AIã®å®Ÿè£…",
          "ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æŠ€è¡“",
          "ã‚²ãƒ¼ãƒ å†…çµŒæ¸ˆã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ",
          "å€‹äººé–‹ç™ºã§ã®ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ³ã‚°æˆ¦ç•¥",
          "ã‚²ãƒ¼ãƒ ã‚¨ãƒ³ã‚¸ãƒ³ã®é¸ã³æ–¹",
          "ãƒ‡ãƒãƒƒã‚°ã¨ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°æŠ€è¡“",
          "ChatGPT/Claudeæ´»ç”¨ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°",
          "AIç”Ÿæˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å“è³ªå‘ä¸Š",
          "ãƒ­ãƒ¼ã‚«ãƒ«AIãƒ¢ãƒ‡ãƒ«ã®æ´»ç”¨",
          "AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°",
          "PythonÃ—AIé–‹ç™ºã®åŸºç¤",
          "JavaScript/TypeScriptå®Ÿè·µ",
          "React Server Componentsæ´»ç”¨",
          "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æœ€æ–°ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯",
          "APIã¨ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹è¨­è¨ˆ",
          "Git/GitHubåŠ¹ç‡çš„æ´»ç”¨æ³•",
          "ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ãƒãƒ¼ãƒ é–‹ç™º",
          "ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºï¼ˆTDDï¼‰",
          "AIã‚’æ´»ç”¨ã—ãŸãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºUI",
          "3Dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³",
          "ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œè¨­è¨ˆ",
          "éŸ³å£°UIã¨ãƒãƒ³ã‚ºãƒ•ãƒªãƒ¼æ“ä½œ",
        ],
        exampleTweets: [
          "åƒ•ã¯çµå±€Claude Codeã°ã‹ã‚Šä½¿ã£ã¦ã„ã¾ã™ã€‚ç†ç”±ã¨ã—ã¦ã¯\nãƒ»Claude Codeã§å›°ã‚‹ã“ã¨ãŒç¾çŠ¶ãªã„(ãƒãƒ³ã‚³ãƒ„æ”¹å–„ã•ã‚ŒãŸæ°—ãŒã™ã‚‹)\nãƒ»Claude Codeã®æ–¹ãŒã‚³ãƒ¼ãƒ‰å‡ºåŠ›ãŒæ—©ã„",
          "ã‚°ãƒ¼ã‚°ãƒ«ç”»åƒç”ŸæˆAIã€ŒNano Bananaã€è¶…ä¾¿åˆ©ã«ä½¿ãˆã‚‹ç¥ã‚¢ãƒ—ãƒª AIé–‹ç™ºã§ç¶šã€…ç™»å ´\nGoogle AI Studioã®Buildã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€Nano Bananaã¨é€£æºã—ãŸä¾¿åˆ©ã§å¼·åŠ›ãªã‚¢ãƒ—ãƒªã‚’ç°¡å˜ã«ä½œã‚Œã‚‹ã“ã¨ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚æ–‡ä¸­ã§è§¦ã‚ŒãŸç­†è€…ä½œæˆã®ã‚¢ãƒ—ãƒªãƒªãƒ³ã‚¯ã‚‚æœ€å¾Œã«å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚",
          "æœ€è¿‘ã€ã‚²ãƒ¼ãƒ ã®ãƒãƒ©ãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã—ã¦ã¿ãŸã‚“ã ã‘ã©ã€æ€ã£ãŸã‚ˆã‚Šæ•µãŒå¼·ã™ãã¦ç¬‘ã£ãŸğŸ˜‚ğŸ˜Šèª¿æ•´ãŒæ¥½ã—ã„ï¼è©¦è¡ŒéŒ¯èª¤ã—ãªãŒã‚‰ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ°—æŒã¡ã‚’è€ƒãˆã‚‹ã£ã¦å¤§äº‹ã ã­ã€œ",
          "GitHubã®åŠ¹ç‡çš„æ´»ç”¨æ³•ã‚’æ¢ã—ã¦ã‚‹ã‚“ã ã‘ã©ã€ã‚„ã£ã±ã‚Šãƒ–ãƒ©ãƒ³ãƒæ´»ç”¨ãŒã‚ã£ã¡ã‚ƒä¾¿åˆ©âœ¨ä½œæ¥­ã”ã¨ã«åˆ†ã‘ã¦ãŠãã¨ã€ãƒã‚°ä¿®æ­£ã‚‚æ¥½ãƒãƒ³ãªã‚“ã ã‚ˆã­!ã¿ã‚“ãªã‚‚è©¦ã—ã¦ã¿ã¦ã€œ!",
          "å°±æ´»ã®æ™‚GitHubè¦‹ã‚‰ã‚Œã‚‹ã£ã¦èã„ãŸã‹ã‚‰çµæ§‹é ‘å¼µã£ã¦ç¶™ç¶šã—ã¦ããŸã¤ã‚‚ã‚Šã ã‘ã©ã€å…¨éƒ¨åŸ‹ã¾ã£ã¦ã‚‹äººã®ãƒ„ã‚¤ãƒ¼ãƒˆè¦‹ã¤ã‘ã¦éœ‡ãˆã¦ã‚‹",
          "ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢è·ã¯é¬±ã«ãªã‚Šã‚„ã™ã„ã¨è¨€ã‚ã‚Œã‚‹ãŒé¬±ã«ãªã‚Šã‚„ã™ã„å¥´ãŒã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢è·ï¼ˆãƒ—ãƒ­ã‚°ãƒ©ãƒï¼‰ã‚’ç›®æŒ‡ã—ãŒã¡ã¨ã„ã†æ–¹ãŒãŠãã‚‰ãæ­£ã—ã„æ°—ãŒã™ã‚‹...",
          "ãµã¨æ€ã£ã¦ã‚“ã‘ã©ã€ãƒã‚¤ãƒ–ã‚³ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒæ™®é€šã«ãªã£ã¦ãã¦ã€å­¦ç¿’é‡ã®å•é¡ŒãŒæ”¹å–„ã•ã‚Œã¦ãã‚‹ã¨ã€ã‚‚ã—ã‹ã™ã‚‹ã¨é™çš„è¨€èªã®æ–¹ãŒæœ‰åˆ©ã«ãªã£ã¦ã“ãªã„ï¼Ÿ\nã‚‚ã—ãã¯ãã‚Œã«ç‰¹åŒ–ã—ãŸè¨€èªã¨ã‹ã‚‚ã†ä½œã£ã¦ã‚‹äººã„ãã†ã‚„ãªã€‚å¤šåˆ†ä»Šå¾Œã¯ãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³å•é¡Œã‚‚å°‘ãªããªã£ã¦æ¥ãã†ã‚„ã—ã€‚",
          "ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¶ä½œã§å£ã«ã¶ã¤ã‹ã£ãŸğŸ’¦ãƒ¬ãƒ™ãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³ã£ã¦ã€è¦‹ãŸç›®ã ã‘ã˜ã‚ƒãªãã¦ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å‹•ãã‚‚è€ƒãˆãªãã‚ƒã„ã‘ãªã„ã‚“ã ã‚ˆã­ï¼è©¦è¡ŒéŒ¯èª¤ã—ã¦ã€å‹é”ã«ãƒ—ãƒ¬ã‚¤ã—ã¦ã‚‚ã‚‰ã£ãŸã‚‰æ”¹å–„ç‚¹ãŒè¦‹ãˆã¦ããŸâœ¨ã‚„ã£ã±ã‚Šäººã®æ„è¦‹ã£ã¦å¤§äº‹ã ã­ï¼"
        ]
      }
    };

    // ãƒˆãƒ¬ãƒ³ãƒ‰ãƒˆãƒ”ãƒƒã‚¯ã‚’ä¿å­˜
    this.trendingTopics = [];
  }

  /**
   * ãƒˆãƒ¬ãƒ³ãƒ‰ãƒˆãƒ”ãƒƒã‚¯ã‚’æ›´æ–°
   * @param {string[]} topics - æ–°ã—ã„ãƒˆãƒ¬ãƒ³ãƒ‰ãƒˆãƒ”ãƒƒã‚¯ã®é…åˆ—
   */
  updateTrendingTopics(topics) {
    this.trendingTopics = topics;
    console.log('Updated trending topics:', topics);
  }

  /**
   * ç¾åœ¨ã®ãƒ†ãƒ¼ãƒãƒªã‚¹ãƒˆã‚’å–å¾—ï¼ˆãƒˆãƒ¬ãƒ³ãƒ‰å„ªå…ˆï¼‰
   * @param {string} promptType - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¿ã‚¤ãƒ—
   * @returns {string[]} ãƒ†ãƒ¼ãƒã®é…åˆ—
   */
  getThemes(promptType = 'rakuten_mobile') {
    const baseThemes = this.promptTemplates[promptType].themes;

    // ãƒˆãƒ¬ãƒ³ãƒ‰ãƒˆãƒ”ãƒƒã‚¯ãŒã‚ã‚Œã°å„ªå…ˆçš„ã«é…ç½®ï¼ˆ100%ã®ç¢ºç‡ã§é¸ã°ã‚Œã‚‹ - æ¤œè¨¼ç”¨ï¼‰
    if (this.trendingTopics.length > 0) {
      return this.trendingTopics;
    }

    return baseThemes;
  }

  async generateTweet(promptType = 'rakuten_mobile') {
    try {
      const template = this.promptTemplates[promptType];
      if (!template) {
        throw new Error(`Unknown prompt type: ${promptType}`);
      }

      // ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’å«ã‚€ãƒ†ãƒ¼ãƒãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠ
      const themes = this.getThemes(promptType);
      const randomTheme = themes[Math.floor(Math.random() * themes.length)];
      const prompt = this.buildPrompt(template, randomTheme);

      const response = await this.openai.chat.completions.create({
        model: "gpt-4o-mini",
        messages: [
          {
            role: "system",
            content: template.system
          },
          {
            role: "user", 
            content: prompt
          }
        ],
        max_tokens: 300,
        temperature: 0.8,
      });

      const generatedContent = response.choices[0].message.content.trim();
      
      // æ¥½å¤©ãƒ¢ãƒã‚¤ãƒ«ã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒªãƒ³ã‚¯ã‚’è¿½åŠ 
      const finalContent = generatedContent;

      return {
        success: true,
        content: finalContent,
        timestamp: new Date(),
        promptType: promptType,
        theme: randomTheme
      };

    } catch (error) {
      console.error('AI Generation Error:', error);
      return this.handleApiError(error);
    }
  }

  buildPrompt(template, theme) {
    const examplesList = template.exampleTweets
      .map((tweet, index) => `${index + 1}. ${tweet}`)
      .join('\n\n');

    return `ãƒ†ãƒ¼ãƒã€Œ${theme}ã€ã«åŸºã¥ã„ã¦ã€ãƒ„ã‚¤ãƒ¼ãƒˆæ–‡ã‚’1ã¤ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
ä»¥ä¸‹ã®ä¾‹æ–‡ã®ã‚ˆã†ãªæ§‹æˆã«ã—ã¦ãã ã•ã„ï¼š
${examplesList}
`;
  }

  handleApiError(error) {
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®åŸºæœ¬ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const fallbackMessages = [
      "æ¥½å¤©ãƒ¢ãƒã‚¤ãƒ«ã§é€šä¿¡è²»ã‚’è³¢ãç¯€ç´„ï¼æµ®ã„ãŸãŠé‡‘ã§æŠ•è³‡ã‚„NISAã‚’å§‹ã‚ã¾ã›ã‚“ã‹ï¼Ÿ #æ¥½å¤©ãƒ¢ãƒã‚¤ãƒ« #ç¯€ç´„è¡“ #è³‡ç”£é‹ç”¨",
      "æ¥½å¤©ãƒã‚¤ãƒ³ãƒˆãŒã‚¶ã‚¯ã‚¶ã‚¯è²¯ã¾ã‚‹ï¼æ—¥ã€…ã®æ”¯å‡ºã‚’ãŠå¾—ã«å¤‰ãˆã¦ã€å®Ÿè³ªçš„ãªç¯€ç´„ã‚’å®Ÿç¾ã—ã¾ã—ã‚‡ã†ï¼ #æ¥½å¤©ãƒã‚¤ãƒ³ãƒˆ #ãƒã‚¤æ´»",
      "ãƒ‡ãƒ¼ã‚¿ç„¡åˆ¶é™ã§å¿«é©é€šä¿¡ï¼æœˆæœ«ã®é€Ÿåº¦åˆ¶é™ã«æ‚©ã¾ã•ã‚Œã‚‹ã“ã¨ãªãã€ã‚¹ãƒˆãƒ¬ã‚¹ãƒ•ãƒªãƒ¼ãªé€šä¿¡ç’°å¢ƒã‚’æ‰‹ã«å…¥ã‚Œã‚ˆã†ï¼ #æ¥½å¤©ãƒ¢ãƒã‚¤ãƒ« #ãƒ‡ãƒ¼ã‚¿ç„¡åˆ¶é™"
    ];

    const randomFallback = fallbackMessages[Math.floor(Math.random() * fallbackMessages.length)];
    
    return {
      success: false,
      content: randomFallback + '\n\nâ–¼ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã¯ã“ã¡ã‚‰\nhttps://r10.to/h5O3vB',
      error: error.message,
      timestamp: new Date(),
      promptType: 'fallback'
    };
  }

  // ãƒ†ã‚¹ãƒˆç”¨ãƒ¡ã‚½ãƒƒãƒ‰
  async testConnection() {
    try {
      const response = await this.openai.chat.completions.create({
        model: "gpt-4o-mini",
        messages: [{ role: "user", content: "ã“ã‚“ã«ã¡ã¯" }],
        max_tokens: 10
      });
      
      console.log('OpenAI APIæ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ');
      return true;
    } catch (error) {
      console.error('OpenAI APIæ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—:', error.message);
      return false;
    }
  }
}

module.exports = AIGenerator;